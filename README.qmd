---
title: matrixBP
format: gfm
---


```{r}
library(matrixBP)
library(RColorBrewer)
library(cowplot)
theme_set(theme_cowplot())


# need to install the package before this script will work.
if(FALSE)
{
  # After cloning the repo, create a new R Project (File -> New Project... -> Existing Directory) and run the following command in the console:
  # Download https://nih-my.sharepoint.com/:u:/g/personal/johnsonra_nih_gov/EeEo-VNRXchMl47X2jhcHLcB2IaSH--TKOcUpS5OLvBoSQ?e=lQwu9Q and save it to `data/metlip.rda`
  devtools::install()
}


# Load the data
data(metlip)

# colors for facet_grid labels
grp_colors <- levels(metlip$Group) |>
  length() |>
  brewer.pal('Set3')
names(grp_colors) <- levels(metlip$Group)


# plot with colored facets
matrix_barplot(metlip, aes(x = Lipid, y = neg_log_p, color = log2FC),
               cols = vars(Group), rows = vars(sample), facet_colors = grp_colors) |>
  mBP_legend()


# change the color of the bars
g1 <- matrix_barplot(metlip, aes(x = Lipid, y = neg_log_p, color = log2FC),
               cols = vars(Group), rows = vars(sample), facet_colors = grp_colors) +
  scale_color_gradient2(low = 'purple3', high = 'orange3')

mBP_legend(g1)


# plot with labeled facets doesn't want to plot to the preview window
# the labels are also messed up and need some help
matrix_barplot(metlip, aes(x = Lipid, y = neg_log_p, color = log2FC),
               cols = vars(Acyl_1), rows = vars(sample)) |>
  mBP_labels()

# adding text labels when coloring the x-axis of facet_colors also has the same issue
matrix_barplot(metlip, aes(x = Lipid, y = neg_log_p, color = log2FC),
               cols = vars(Group), rows = vars(sample), facet_colors = grp_colors) |>
  mBP_labels()


# trying to plot multiple samples on a single row causes the colors not to work
# add a catch that will notify the user if they try to do this
matrix_barplot(metlip, aes(x = Lipid, y = neg_log_p, color = log2FC),
               cols = vars(Group), facet_colors = grp_colors) |>
  mBP_legend()


# try adding `na.rm = TRUE` to `scale_...` to see if that gets rid of warnings about NA values
```
